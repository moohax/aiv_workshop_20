MSFT_SPServiceAppSecurity.psm1,c9af664968208c00dde408936bb5fe9f,Scan result is 1. IsMalware: 0,ZnVuY3Rpb24gR2V0LVRhcmdldFJlc291cmNlCnsKICAgIFtDbWRsZXRCaW5kaW5nKCldCiAgICBbT3V0cHV0VHlwZShbU3lzdGVtLkNvbGxlY3Rpb25zLkhhc2h0YWJsZV0pXQogICAgcGFyYW0KICAgICgKICAgICAgICBbcGFyYW1ldGVyKE1hbmRhdG9yeSA9ICR0cnVlKV0gIFtTeXN0ZW0uU3RyaW5nXSAkU2VydmljZUFwcE5hbWUsCiAgICAgICAgW3BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldICBbVmFsaWRhdGVTZXQoIkFkbWluaXN0cmF0b3JzIiwiU2hhcmluZ1Blcm1pc3Npb25zIildIFtTeXN0ZW0uU3RyaW5nXSAkU2VjdXJpdHlUeXBlLAogICAgICAgIFtwYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0gW01pY3Jvc29mdC5NYW5hZ2VtZW50LkluZnJhc3RydWN0dXJlLkNpbUluc3RhbmNlW11dICRNZW1iZXJzLAogICAgICAgIFtwYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0gW01pY3Jvc29mdC5NYW5hZ2VtZW50LkluZnJhc3RydWN0dXJlLkNpbUluc3RhbmNlW11dICRNZW1iZXJzVG9JbmNsdWRlLAogICAgICAgIFtwYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0gW1N5c3RlbS5TdHJpbmdbXV0gJE1lbWJlcnNUb0V4Y2x1ZGUsCiAgICAgICAgW3BhcmFtZXRlcihNYW5kYXRvcnkgPSAkZmFsc2UpXSBbU3lzdGVtLk1hbmFnZW1lbnQuQXV0b21hdGlvbi5QU0NyZWRlbnRpYWxdICRJbnN0YWxsQWNjb3VudAogICAgKQoKICAgIGlmICgkTWVtYmVycyAtYW5kICgoJE1lbWJlcnNUb0luY2x1ZGUpIC1vciAoJE1lbWJlcnNUb0V4Y2x1ZGUpKSkgewogICAgICAgIFRocm93ICJDYW5ub3QgdXNlIHRoZSBNZW1iZXJzIHBhcmFtZXRlciB0b2dldGhlciB3aXRoIHRoZSBNZW1iZXJzVG9JbmNsdWRlIG9yIE1lbWJlcnNUb0V4Y2x1ZGUgcGFyYW1ldGVycyIKICAgIH0KCiAgICBpZiAoISRNZW1iZXJzIC1hbmQgISRNZW1iZXJzVG9JbmNsdWRlIC1hbmQgISRNZW1iZXJzVG9FeGNsdWRlKSB7CiAgICAgICAgdGhyb3cgIkF0IGxlYXN0IG9uZSBvZiB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnMgbXVzdCBiZSBzcGVjaWZpZWQ6IE1lbWJlcnMsIE1lbWJlcnNUb0luY2x1ZGUsIE1lbWJlcnNUb0V4Y2x1ZGUiCiAgICB9CgogICAgV3JpdGUtVmVyYm9zZSAtTWVzc2FnZSAiR2V0dGluZyBhbGwgc2VjdXJpdHkgb3B0aW9ucyBmb3IgJFNlY3VyaXR5VHlwZSBpbiAkU2VydmljZUFwcE5hbWUiCgogICAgJHJlc3VsdCA9IEludm9rZS1TUERTQ0NvbW1hbmQgLUNyZWRlbnRpYWwgJEluc3RhbGxBY2NvdW50IC1Bcmd1bWVudHMgJFBTQm91bmRQYXJhbWV0ZXJzIC1TY3JpcHRCbG9jayB7CiAgICAgICAgJHBhcmFtcyA9ICRhcmdzWzBdCgogICAgICAgICRzZXJ2aWNlQXBwID0gR2V0LVNQU2VydmljZUFwcGxpY2F0aW9uIC1OYW1lICRwYXJhbXMuU2VydmljZUFwcE5hbWUKICAgICAgICAKICAgICAgICBpZiAoJG51bGwgLWVxICRzZXJ2aWNlQXBwKSB7CiAgICAgICAgICAgIHJldHVybiBAewogICAgICAgICAgICAgICAgU2VydmljZUFwcE5hbWUgPSAiIgogICAgICAgICAgICAgICAgU2VjdXJpdHlUeXBlID0gJHBhcmFtcy5TZWN1cml0eVR5cGUKICAgICAgICAgICAgICAgIEluc3RhbGxBY2NvdW50ID0gJHBhcmFtcy5JbnN0YWxsQWNjb3VudAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHN3aXRjaCAoJHBhcmFtcy5TZWN1cml0eVR5cGUpIHsKICAgICAgICAgICAgIkFkbWluaXN0cmF0b3JzIiB7IAogICAgICAgICAgICAgICAgJHNlY3VyaXR5ID0gJHNlcnZpY2VBcHAgfCBHZXQtU1BTZXJ2aWNlQXBwbGljYXRpb25TZWN1cml0eSAtQWRtaW4KICAgICAgICAgICAgIH0KICAgICAgICAgICAgIlNoYXJpbmdQZXJtaXNzaW9ucyIgewogICAgICAgICAgICAgICAgJHNlY3VyaXR5ID0gJHNlcnZpY2VBcHAgfCBHZXQtU1BTZXJ2aWNlQXBwbGljYXRpb25TZWN1cml0eQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgICRtZW1iZXJzID0gQCgpCiAgICAgICAgZm9yZWFjaCAoJHNlY3VyaXR5RW50cnkgaW4gJHNlY3VyaXR5LkFjY2Vzc1J1bGVzKSB7CiAgICAgICAgICAgIAogICAgICAgICAgICAkdXNlciA9ICRzZWN1cml0eUVudHJ5Lk5hbWUKICAgICAgICAgICAgaWYgKCR1c2VyIC1saWtlICJpOip8KiIgLW9yICR1c2VyIC1saWtlICJjOip8KiIpIHsKICAgICAgICAgICAgICAgICR1c2VyID0gKE5ldy1TUENsYWltc1ByaW5jaXBhbCAtSWRlbnRpdHkgJHVzZXIgLUlkZW50aXR5VHlwZSBFbmNvZGVkQ2xhaW0pLlZhbHVlCiAgICAgICAgICAgICAgICBpZiAoJHVzZXIgLW1hdGNoICJecy0xLVswLTU5XS1cZCstXGQrLVxkKy1cZCstXGQrIikKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAkdXNlciA9IFJlc29sdmUtU1BEc2NTZWN1cml0eUlkZW50aWZpZXIgLVNJRCAkdXNlcgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgICRtZW1iZXJzICs9IEB7CiAgICAgICAgICAgICAgICBVc2VybmFtZSAgICA9ICR1c2VyCiAgICAgICAgICAgICAgICBBY2Nlc3NMZXZlbCA9ICRzZWN1cml0eUVudHJ5LkFsbG93ZWRSaWdodHMuVG9TdHJpbmcoKS5SZXBsYWNlKCJGdWxsQ29udHJvbCIsICJGdWxsIENvbnRyb2wiKS5SZXBsYWNlKCJDaGFuZ2VQZXJtaXNzaW9ucyIsICJDaGFuZ2UgUGVybWlzc2lvbnMiKQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiBAewogICAgICAgICAgICBTZXJ2aWNlQXBwTmFtZSAgID0gJHBhcmFtcy5TZXJ2aWNlQXBwTmFtZQogICAgICAgICAgICBTZWN1cml0eVR5cGUgICAgID0gJHBhcmFtcy5TZWN1cml0eVR5cGUKICAgICAgICAgICAgTWVtYmVycyAgICAgICAgICA9ICRtZW1iZXJzCiAgICAgICAgICAgIE1lbWJlcnNUb0luY2x1ZGUgPSAkcGFyYW1zLk1lbWJlcnNUb0luY2x1ZGUKICAgICAgICAgICAgTWVtYmVyc1RvRXhjbHVkZSA9ICRwYXJhbXMuTWVtYmVyc1RvRXhjbHVkZQogICAgICAgICAgICBJbnN0YWxsQWNjb3VudCAgID0gJHBhcmFtcy5JbnN0YWxsQWNjb3VudAogICAgICAgIH0KICAgIH0KICAgIHJldHVybiAkcmVzdWx0Cn0KCgpmdW5jdGlvbiBTZXQtVGFyZ2V0UmVzb3VyY2UKewogICAgW0NtZGxldEJpbmRpbmcoKV0KICAgIHBhcmFtCiAgICAoCiAgICAgICAgW3BhcmFtZXRlcihNYW5kYXRvcnkgPSAkdHJ1ZSldICBbU3lzdGVtLlN0cmluZ10gJFNlcnZpY2VBcHBOYW1lLAogICAgICAgIFtwYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXSAgW1ZhbGlkYXRlU2V0KCJBZG1pbmlzdHJhdG9ycyIsIlNoYXJpbmdQZXJtaXNzaW9ucyIpXSBbU3lzdGVtLlN0cmluZ10gJFNlY3VyaXR5VHlwZSwKICAgICAgICBbcGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldIFtNaWNyb3NvZnQuTWFuYWdlbWVudC5JbmZyYXN0cnVjdHVyZS5DaW1JbnN0YW5jZVtdXSAkTWVtYmVycywKICAgICAgICBbcGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldIFtNaWNyb3NvZnQuTWFuYWdlbWVudC5JbmZyYXN0cnVjdHVyZS5DaW1JbnN0YW5jZVtdXSAkTWVtYmVyc1RvSW5jbHVkZSwKICAgICAgICBbcGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldIFtTeXN0ZW0uU3RyaW5nW11dICRNZW1iZXJzVG9FeGNsdWRlLAogICAgICAgIFtwYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJGZhbHNlKV0gW1N5c3RlbS5NYW5hZ2VtZW50LkF1dG9tYXRpb24uUFNDcmVkZW50aWFsXSAkSW5zdGFsbEFjY291bnQKICAgICkKCiAgICBXcml0ZS1WZXJib3NlIC1NZXNzYWdlICJTZXR0aW5nIHNlcnZpY2UgYXBwIHNlY3VyaXR5IGNvbmZpZyIKICAgIAogICAgaWYgKCRNZW1iZXJzIC1hbmQgKCgkTWVtYmVyc1RvSW5jbHVkZSkgLW9yICgkTWVtYmVyc1RvRXhjbHVkZSkpKSB7CiAgICAgICAgVGhyb3cgIkNhbm5vdCB1c2UgdGhlIE1lbWJlcnMgcGFyYW1ldGVyIHRvZ2V0aGVyIHdpdGggdGhlIE1lbWJlcnNUb0luY2x1ZGUgb3IgTWVtYmVyc1RvRXhjbHVkZSBwYXJhbWV0ZXJzIgogICAgfQoKICAgIGlmICghJE1lbWJlcnMgLWFuZCAhJE1lbWJlcnNUb0luY2x1ZGUgLWFuZCAhJE1lbWJlcnNUb0V4Y2x1ZGUpIHsKICAgICAgICB0aHJvdyAiQXQgbGVhc3Qgb25lIG9mIHRoZSBmb2xsb3dpbmcgcGFyYW1ldGVycyBtdXN0IGJlIHNwZWNpZmllZDogTWVtYmVycywgTWVtYmVyc1RvSW5jbHVkZSwgTWVtYmVyc1RvRXhjbHVkZSIKICAgIH0KCiAgICAkQ3VycmVudFZhbHVlcyA9IEdldC1UYXJnZXRSZXNvdXJjZSBAUFNCb3VuZFBhcmFtZXRlcnMKICAgIAogICAgaWYgKFtTeXN0ZW0uU3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkQ3VycmVudFZhbHVlcy5TZXJ2aWNlQXBwTmFtZSkgLWVxICR0cnVlKSB7IAogICAgICAgIHRocm93ICJVbmFibGUgdG8gbG9jYXRlIHNlcnZpY2UgYXBwbGljYXRpb24gJFNlcnZpY2VBcHBOYW1lIgogICAgfQogICAgCiAgICBJbnZva2UtU1BEU0NDb21tYW5kIC1DcmVkZW50aWFsICRJbnN0YWxsQWNjb3VudCAtQXJndW1lbnRzIEAoJFBTQm91bmRQYXJhbWV0ZXJzLCAkQ3VycmVudFZhbHVlcykgLVNjcmlwdEJsb2NrIHsKICAgICAgICAkcGFyYW1zID0gJGFyZ3NbMF0KICAgICAgICAkQ3VycmVudFZhbHVlcyA9ICRhcmdzWzFdCiAgICAgICAgCiAgICAgICAgJHNlcnZpY2VBcHAgPSBHZXQtU1BTZXJ2aWNlQXBwbGljYXRpb24gLU5hbWUgJHBhcmFtcy5TZXJ2aWNlQXBwTmFtZQogICAgICAgIHN3aXRjaCAoJHBhcmFtcy5TZWN1cml0eVR5cGUpIHsKICAgICAgICAgICAgIkFkbWluaXN0cmF0b3JzIiB7IAogICAgICAgICAgICAgICAgJHNlY3VyaXR5ID0gJHNlcnZpY2VBcHAgfCBHZXQtU1BTZXJ2aWNlQXBwbGljYXRpb25TZWN1cml0eSAtQWRtaW4KICAgICAgICAgICAgIH0KICAgICAgICAgICAgIlNoYXJpbmdQZXJtaXNzaW9ucyIgewogICAgICAgICAgICAgICAgJHNlY3VyaXR5ID0gJHNlcnZpY2VBcHAgfCBHZXQtU1BTZXJ2aWNlQXBwbGljYXRpb25TZWN1cml0eQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgICAKICAgICAgICBpZiAoJHBhcmFtcy5Db250YWluc0tleSgiTWVtYmVycyIpIC1lcSAkdHJ1ZSkgewogICAgICAgICAgICAjIEl0ZXJhdGUgdGhlIGRlc2lyZWQgbWVtYmVycyB0byBtYWtlIHN1cmUgdGhleSBhcmUgcHJlc2VudCB3aXRoIGNvcnJlY3Qgc2V0dGluZ3MKICAgICAgICAgICAgZm9yZWFjaCgkZGVzaXJlZE1lbWJlciBpbiAkcGFyYW1zLk1lbWJlcnMpIHsKICAgICAgICAgICAgICAgICRpc1VzZXIgPSBUZXN0LVNQRFNDSXNBRFVzZXIgLUlkZW50aXR5TmFtZSAkZGVzaXJlZE1lbWJlci5Vc2VybmFtZQogICAgICAgICAgICAgICAgaWYgKCRpc1VzZXIgLWVxICR0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgJGNsYWltID0gTmV3LVNQQ2xhaW1zUHJpbmNpcGFsIC1JZGVudGl0eSAkZGVzaXJlZE1lbWJlci5Vc2VybmFtZSAtSWRlbnRpdHlUeXBlIFdpbmRvd3NTYW1BY2NvdW50TmFtZSAgICAKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgJGNsYWltID0gTmV3LVNQQ2xhaW1zUHJpbmNpcGFsIC1JZGVudGl0eSAkZGVzaXJlZE1lbWJlci5Vc2VybmFtZSAtSWRlbnRpdHlUeXBlIFdpbmRvd3NTZWN1cml0eUdyb3VwTmFtZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgKCRDdXJyZW50VmFsdWVzLk1lbWJlcnMuVXNlcm5hbWUgLWNvbnRhaW5zICRkZXNpcmVkTWVtYmVyLlVzZXJuYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgIyBUaGUgdXNlciBhbHJlYWR5IGhhcyBhIHBlcm1pc3Npb24sIGNoZWNrIHRoYXQgaXQgaXMgY29ycmVjdAogICAgICAgICAgICAgICAgICAgIGlmICgoJEN1cnJlbnRWYWx1ZXMuTWVtYmVycyB8IFdoZXJlLU9iamVjdCB7ICRfLlVzZXJuYW1lIC1lcSAkZGVzaXJlZE1lbWJlci5Vc2VybmFtZSB9IHwgU2VsZWN0LU9iamVjdCAtRmlyc3QgMSkuQWNjZXNzTGV2ZWwgLW5lICRkZXNpcmVkTWVtYmVyLkFjY2Vzc0xldmVsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICMgQ3VycmVudCBwZXJtaXNzaW9uIGZvciB1c2VyIGRvZXNuJ3QgbWF0Y2ggd2hhdCBpdCBzaG91bGQsIHJlbW92ZSB0aGVtIGFuZCByZS1hZGQgdGhlbSAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIFJldm9rZS1TUE9iamVjdFNlY3VyaXR5IC1JZGVudGl0eSAkc2VjdXJpdHkgLVByaW5jaXBhbCAkY2xhaW0KICAgICAgICAgICAgICAgICAgICAgICAgR3JhbnQtU1BPYmplY3RTZWN1cml0eSAtSWRlbnRpdHkgJHNlY3VyaXR5IC1QcmluY2lwYWwgJGNsYWltIC1SaWdodHMgJGRlc2lyZWRNZW1iZXIuQWNjZXNzTGV2ZWwKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICMgVGhlIGRlc2lyZWQgbWVtYmVyIGlzIG5vdCBvbiB0aGUgbGlzdCwgYWRkIHRoZW0KICAgICAgICAgICAgICAgICAgICBHcmFudC1TUE9iamVjdFNlY3VyaXR5IC1JZGVudGl0eSAkc2VjdXJpdHkgLVByaW5jaXBhbCAkY2xhaW0gLVJpZ2h0cyAkZGVzaXJlZE1lbWJlci5BY2Nlc3NMZXZlbAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIEl0ZXJhdGUgdGhlIGN1cnJlbnQgbWVtYmVycyB0byBtYWtlIHN1cmUgdGhleSBhcmUgaW4gdGhlIGRlc2lyZWQgbGlzdCwgcmVtb3ZlIHRob3NlIHdobyBhcmVuJ3QKICAgICAgICAgICAgZm9yZWFjaCgkY3VycmVudE1lbWJlciBpbiAkQ3VycmVudFZhbHVlcy5NZW1iZXJzKSB7CiAgICAgICAgICAgICAgICBpZiAoJHBhcmFtcy5NZW1iZXJzLlVzZXJuYW1lIC1ub3Rjb250YWlucyAkY3VycmVudE1lbWJlci5Vc2VybmFtZSkgewogICAgICAgICAgICAgICAgICAgICMgQ3VycmVudCBtZW1iZXIgaXMgbm90IGluIGRlc2lyZWQgbWVtYmVycyBsaXN0LCByZW1vdmUgaXQKICAgICAgICAgICAgICAgICAgICAkaXNVc2VyID0gVGVzdC1TUERTQ0lzQURVc2VyIC1JZGVudGl0eU5hbWUgJGRlc2lyZWRNZW1iZXIuVXNlcm5hbWUKICAgICAgICAgICAgICAgICAgICBpZiAoJGlzVXNlciAtZXEgJHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGNsYWltID0gTmV3LVNQQ2xhaW1zUHJpbmNpcGFsIC1JZGVudGl0eSAkZGVzaXJlZE1lbWJlci5Vc2VybmFtZSAtSWRlbnRpdHlUeXBlIFdpbmRvd3NTYW1BY2NvdW50TmFtZSAgICAKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAkY2xhaW0gPSBOZXctU1BDbGFpbXNQcmluY2lwYWwgLUlkZW50aXR5ICRkZXNpcmVkTWVtYmVyLlVzZXJuYW1lIC1JZGVudGl0eVR5cGUgV2luZG93c1NlY3VyaXR5R3JvdXBOYW1lCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIFJldm9rZS1TUE9iamVjdFNlY3VyaXR5IC1JZGVudGl0eSAkc2VjdXJpdHkgLVByaW5jaXBhbCAkY2xhaW0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCRwYXJhbXMuQ29udGFpbnNLZXkoIk1lbWJlcnNUb0luY2x1ZGUiKSAtZXEgJHRydWUpIHsKICAgICAgICAgICAgIyBJdGVyYXRlIHRoZSBkZXNpcmVkIG1lbWJlcnMgdG8gbWFrZSBzdXJlIHRoZXkgYXJlIHByZXNlbnQgd2l0aCBjb3JyZWN0IHNldHRpbmdzCiAgICAgICAgICAgIGZvcmVhY2goJGRlc2lyZWRNZW1iZXIgaW4gJHBhcmFtcy5NZW1iZXJzVG9JbmNsdWRlKSB7CiAgICAgICAgICAgICAgICAkaXNVc2VyID0gVGVzdC1TUERTQ0lzQURVc2VyIC1JZGVudGl0eU5hbWUgJGRlc2lyZWRNZW1iZXIuVXNlcm5hbWUKICAgICAgICAgICAgICAgIGlmICgkaXNVc2VyIC1lcSAkdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICRjbGFpbSA9IE5ldy1TUENsYWltc1ByaW5jaXBhbCAtSWRlbnRpdHkgJGRlc2lyZWRNZW1iZXIuVXNlcm5hbWUgLUlkZW50aXR5VHlwZSBXaW5kb3dzU2FtQWNjb3VudE5hbWUgICAgCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICRjbGFpbSA9IE5ldy1TUENsYWltc1ByaW5jaXBhbCAtSWRlbnRpdHkgJGRlc2lyZWRNZW1iZXIuVXNlcm5hbWUgLUlkZW50aXR5VHlwZSBXaW5kb3dzU2VjdXJpdHlHcm91cE5hbWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgkQ3VycmVudFZhbHVlcy5NZW1iZXJzLlVzZXJuYW1lIC1jb250YWlucyAkZGVzaXJlZE1lbWJlci5Vc2VybmFtZSkgewogICAgICAgICAgICAgICAgICAgICMgVGhlIHVzZXIgYWxyZWFkeSBoYXMgYSBwZXJtaXNzaW9uLCBjaGVjayB0aGF0IGl0IGlzIGNvcnJlY3QKICAgICAgICAgICAgICAgICAgICBpZiAoKCRDdXJyZW50VmFsdWVzLk1lbWJlcnMgfCBXaGVyZS1PYmplY3QgeyAkXy5Vc2VybmFtZSAtZXEgJGRlc2lyZWRNZW1iZXIuVXNlcm5hbWUgfSB8IFNlbGVjdC1PYmplY3QgLUZpcnN0IDEpLkFjY2Vzc0xldmVsIC1uZSAkZGVzaXJlZE1lbWJlci5BY2Nlc3NMZXZlbCkgewogICAgICAgICAgICAgICAgICAgICAgICAjIEN1cnJlbnQgcGVybWlzc2lvbiBmb3IgdXNlciBkb2Vzbid0IG1hdGNoIHdoYXQgaXQgc2hvdWxkLCByZW1vdmUgdGhlbSBhbmQgcmUtYWRkIHRoZW0KICAgICAgICAgICAgICAgICAgICAgICAgUmV2b2tlLVNQT2JqZWN0U2VjdXJpdHkgLUlkZW50aXR5ICRzZWN1cml0eSAtUHJpbmNpcGFsICRjbGFpbQogICAgICAgICAgICAgICAgICAgICAgICBHcmFudC1TUE9iamVjdFNlY3VyaXR5IC1JZGVudGl0eSAkc2VjdXJpdHkgLVByaW5jaXBhbCAkY2xhaW0gLVJpZ2h0cyAkZGVzaXJlZE1lbWJlci5BY2Nlc3NMZXZlbAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgIyBUaGUgZGVzaXJlZCBtZW1iZXIgaXMgbm90IG9uIHRoZSBsaXN0LCBhZGQgdGhlbQogICAgICAgICAgICAgICAgICAgIEdyYW50LVNQT2JqZWN0U2VjdXJpdHkgLUlkZW50aXR5ICRzZWN1cml0eSAtUHJpbmNpcGFsICRjbGFpbSAtUmlnaHRzICRkZXNpcmVkTWVtYmVyLkFjY2Vzc0xldmVsCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGlmICgkcGFyYW1zLkNvbnRhaW5zS2V5KCJNZW1iZXJzVG9FeGNsdWRlIikgLWVxICR0cnVlKSB7CiAgICAgICAgICAgICMgSXRlcmF0ZSB0aGUgZXhjbHVkZWQgbWVtYmVycyB0byByZW1vdmUgdGhvc2Ugd2hvIHNob3VsZCBub3QgaGF2ZSBhY2Nlc3MKICAgICAgICAgICAgZm9yZWFjaCgkZXhjbHVkZU1lbWJlciBpbiAkcGFyYW1zLk1lbWJlcnNUb0V4Y2x1ZGUpIHsKICAgICAgICAgICAgICAgIGlmICgkQ3VycmVudFZhbHVlcy5NZW1iZXJzLlVzZXJuYW1lIC1jb250YWlucyAkZXhjbHVkZU1lbWJlcikgewogICAgICAgICAgICAgICAgICAgICMgTWVtYmVyIGhhcyBwZXJtaXNzaW9uLCByZW1vdmluZyBpdAogICAgICAgICAgICAgICAgICAgICRpc1VzZXIgPSBUZXN0LVNQRFNDSXNBRFVzZXIgLUlkZW50aXR5TmFtZSAkZGVzaXJlZE1lbWJlci5Vc2VybmFtZQogICAgICAgICAgICAgICAgICAgIGlmICgkaXNVc2VyIC1lcSAkdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICAkY2xhaW0gPSBOZXctU1BDbGFpbXNQcmluY2lwYWwgLUlkZW50aXR5ICRkZXNpcmVkTWVtYmVyLlVzZXJuYW1lIC1JZGVudGl0eVR5cGUgV2luZG93c1NhbUFjY291bnROYW1lICAgIAogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRjbGFpbSA9IE5ldy1TUENsYWltc1ByaW5jaXBhbCAtSWRlbnRpdHkgJGRlc2lyZWRNZW1iZXIuVXNlcm5hbWUgLUlkZW50aXR5VHlwZSBXaW5kb3dzU2VjdXJpdHlHcm91cE5hbWUKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgUmV2b2tlLVNQT2JqZWN0U2VjdXJpdHkgLUlkZW50aXR5ICRzZWN1cml0eSAtUHJpbmNpcGFsICRjbGFpbQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIAogICAgICAgICMgQ29tbWl0IGFsbCBjaGFuZ2VzCiAgICAgICAgc3dpdGNoICgkcGFyYW1zLlNlY3VyaXR5VHlwZSkgewogICAgICAgICAgICAiQWRtaW5pc3RyYXRvcnMiIHsgCiAgICAgICAgICAgICAgICAkc2VjdXJpdHkgPSAkc2VydmljZUFwcCB8IFNldC1TUFNlcnZpY2VBcHBsaWNhdGlvblNlY3VyaXR5IC1PYmplY3RTZWN1cml0eSAkc2VjdXJpdHkgLUFkbWluCiAgICAgICAgICAgICB9CiAgICAgICAgICAgICJTaGFyaW5nUGVybWlzc2lvbnMiIHsKICAgICAgICAgICAgICAgICRzZWN1cml0eSA9ICRzZXJ2aWNlQXBwIHwgU2V0LVNQU2VydmljZUFwcGxpY2F0aW9uU2VjdXJpdHkgLU9iamVjdFNlY3VyaXR5ICRzZWN1cml0eQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgoKZnVuY3Rpb24gVGVzdC1UYXJnZXRSZXNvdXJjZQp7CiAgICBbQ21kbGV0QmluZGluZygpXQogICAgW091dHB1dFR5cGUoW1N5c3RlbS5Cb29sZWFuXSldCiAgICBwYXJhbQogICAgKAogICAgICAgIFtwYXJhbWV0ZXIoTWFuZGF0b3J5ID0gJHRydWUpXSAgW1N5c3RlbS5TdHJpbmddICRTZXJ2aWNlQXBwTmFtZSwKICAgICAgICBbcGFyYW1ldGVyKE1hbmRhdG9yeSA9ICR0cnVlKV0gIFtWYWxpZGF0ZVNldCgiQWRtaW5pc3RyYXRvcnMiLCJTaGFyaW5nUGVybWlzc2lvbnMiKV0gW1N5c3RlbS5TdHJpbmddICRTZWN1cml0eVR5cGUsCiAgICAgICAgW3BhcmFtZXRlcihNYW5kYXRvcnkgPSAkZmFsc2UpXSBbTWljcm9zb2Z0Lk1hbmFnZW1lbnQuSW5mcmFzdHJ1Y3R1cmUuQ2ltSW5zdGFuY2VbXV0gJE1lbWJlcnMsCiAgICAgICAgW3BhcmFtZXRlcihNYW5kYXRvcnkgPSAkZmFsc2UpXSBbTWljcm9zb2Z0Lk1hbmFnZW1lbnQuSW5mcmFzdHJ1Y3R1cmUuQ2ltSW5zdGFuY2VbXV0gJE1lbWJlcnNUb0luY2x1ZGUsCiAgICAgICAgW3BhcmFtZXRlcihNYW5kYXRvcnkgPSAkZmFsc2UpXSBbU3lzdGVtLlN0cmluZ1tdXSAkTWVtYmVyc1RvRXhjbHVkZSwKICAgICAgICBbcGFyYW1ldGVyKE1hbmRhdG9yeSA9ICRmYWxzZSldIFtTeXN0ZW0uTWFuYWdlbWVudC5BdXRvbWF0aW9uLlBTQ3JlZGVudGlhbF0gJEluc3RhbGxBY2NvdW50CiAgICApCgogICAgV3JpdGUtVmVyYm9zZSAtTWVzc2FnZSAiVGVzdGluZyBzZXJ2aWNlIGFwcCBzZWN1cml0eSBjb25maWciCiAgICAKICAgIGlmICgkTWVtYmVycyAtYW5kICgoJE1lbWJlcnNUb0luY2x1ZGUpIC1vciAoJE1lbWJlcnNUb0V4Y2x1ZGUpKSkgewogICAgICAgIFRocm93ICJDYW5ub3QgdXNlIHRoZSBNZW1iZXJzIHBhcmFtZXRlciB0b2dldGhlciB3aXRoIHRoZSBNZW1iZXJzVG9JbmNsdWRlIG9yIE1lbWJlcnNUb0V4Y2x1ZGUgcGFyYW1ldGVycyIKICAgIH0KCiAgICBpZiAoISRNZW1iZXJzIC1hbmQgISRNZW1iZXJzVG9JbmNsdWRlIC1hbmQgISRNZW1iZXJzVG9FeGNsdWRlKSB7CiAgICAgICAgdGhyb3cgIkF0IGxlYXN0IG9uZSBvZiB0aGUgZm9sbG93aW5nIHBhcmFtZXRlcnMgbXVzdCBiZSBzcGVjaWZpZWQ6IE1lbWJlcnMsIE1lbWJlcnNUb0luY2x1ZGUsIE1lbWJlcnNUb0V4Y2x1ZGUiCiAgICB9CgogICAgJEN1cnJlbnRWYWx1ZXMgPSBHZXQtVGFyZ2V0UmVzb3VyY2UgQFBTQm91bmRQYXJhbWV0ZXJzCgogICAgaWYgKFtTeXN0ZW0uU3RyaW5nXTo6SXNOdWxsT3JFbXB0eSgkQ3VycmVudFZhbHVlcy5TZXJ2aWNlQXBwTmFtZSkgLWVxICR0cnVlKSB7IHJldHVybiAkZmFsc2UgfQogICAgCiAgICBpZiAoJE1lbWJlcnMpIHsKICAgICAgICBXcml0ZS1WZXJib3NlICJQcm9jZXNzaW5nIE1lbWJlcnMgcGFyYW1ldGVyIgogICAgICAgICRkaWZmZXJlbmNlcyA9IENvbXBhcmUtT2JqZWN0IC1SZWZlcmVuY2VPYmplY3QgJEN1cnJlbnRWYWx1ZXMuTWVtYmVycy5Vc2VybmFtZSAtRGlmZmVyZW5jZU9iamVjdCAkTWVtYmVycy5Vc2VybmFtZQoKICAgICAgICBpZiAoJG51bGwgLWVxICRkaWZmZXJlbmNlcykgewogICAgICAgICAgICBXcml0ZS1WZXJib3NlICJTZWN1cml0eSBsaXN0IG1hdGNoZXMgLSBjaGVja2luZyB0aGF0IHBlcm1pc3Npb25zIG1hdGNoIG9uIGVhY2ggb2JqZWN0IgogICAgICAgICAgICBmb3JlYWNoKCRjdXJyZW50TWVtYmVyIGluICRDdXJyZW50VmFsdWVzLk1lbWJlcnMpIHsKICAgICAgICAgICAgICAgIGlmICgkY3VycmVudE1lbWJlci5BY2Nlc3NMZXZlbCAtbmUgKCRNZW1iZXJzIHwgV2hlcmUtT2JqZWN0IHsgJF8uVXNlcm5hbWUgLWVxICRjdXJyZW50TWVtYmVyLlVzZXJuYW1lIH0gfCBTZWxlY3QtT2JqZWN0IC1GaXJzdCAxKS5BY2Nlc3NMZXZlbCkgewogICAgICAgICAgICAgICAgICAgIFdyaXRlLVZlcmJvc2UgIiQoJGN1cnJlbnRNZW1iZXIuVXNlcm5hbWUpIGhhcyBpbmNvcnJlY3QgcGVybWlzc2lvbiBsZXZlbC4gVGVzdCBmYWlsZWQuIgogICAgICAgICAgICAgICAgICAgIHJldHVybiAkZmFsc2UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gJHRydWUKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBXcml0ZS1WZXJib3NlICJTZWN1cml0eSBsaXN0IGRvZXMgbm90IG1hdGNoIgogICAgICAgICAgICByZXR1cm4gJGZhbHNlCiAgICAgICAgfQogICAgfQoKICAgICRyZXN1bHQgPSAkdHJ1ZQogICAgaWYgKCRNZW1iZXJzVG9JbmNsdWRlKSB7CiAgICAgICAgV3JpdGUtVmVyYm9zZSAiUHJvY2Vzc2luZyBNZW1iZXJzVG9JbmNsdWRlIHBhcmFtZXRlciIKICAgICAgICBGb3JFYWNoICgkbWVtYmVyIGluICRNZW1iZXJzVG9JbmNsdWRlKSB7CiAgICAgICAgICAgIGlmICgtbm90KCRDdXJyZW50VmFsdWVzLk1lbWJlcnMuVXNlcm5hbWUgLWNvbnRhaW5zICRtZW1iZXIuVXNlcm5hbWUpKSB7CiAgICAgICAgICAgICAgICBXcml0ZS1WZXJib3NlICIkKCRtZW1iZXIuVXNlcm5hbWUpIGRvZXMgbm90IGhhdmUgYWNjZXNzLiBTZXQgcmVzdWx0IHRvIGZhbHNlIgogICAgICAgICAgICAgICAgJHJlc3VsdCA9ICRmYWxzZQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgV3JpdGUtVmVyYm9zZSAiJCgkbWVtYmVyLlVzZXJuYW1lKSBhbHJlYWR5IGhhcyBhY2Nlc3MuIENoZWNraW5nIHBlcm1pc3Npb24uLi4iCiAgICAgICAgICAgICAgICBpZiAoJG1lbWJlci5BY2Nlc3NMZXZlbCAtbmUgKCRDdXJyZW50VmFsdWVzLk1lbWJlcnMgfCBXaGVyZS1PYmplY3QgeyAkXy5Vc2VybmFtZSAtZXEgJG1lbWJlci5Vc2VybmFtZSB9IHwgU2VsZWN0LU9iamVjdCAtRmlyc3QgMSkuQWNjZXNzTGV2ZWwpIHsKICAgICAgICAgICAgICAgICAgICBXcml0ZS1WZXJib3NlICIkKCRtZW1iZXIuVXNlcm5hbWUpIGhhcyBpbmNvcnJlY3QgcGVybWlzc2lvbiBsZXZlbC4gVGVzdCBmYWlsZWQuIgogICAgICAgICAgICAgICAgICAgIHJldHVybiAkZmFsc2UKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBpZiAoJE1lbWJlcnNUb0V4Y2x1ZGUpIHsKICAgICAgICBXcml0ZS1WZXJib3NlICJQcm9jZXNzaW5nIE1lbWJlcnNUb0V4Y2x1ZGUgcGFyYW1ldGVyIgogICAgICAgIEZvckVhY2ggKCRtZW1iZXIgaW4gJE1lbWJlcnNUb0V4Y2x1ZGUpIHsKICAgICAgICAgICAgaWYgKCRDdXJyZW50VmFsdWVzLk1lbWJlcnMuVXNlcm5hbWUgLWNvbnRhaW5zICRtZW1iZXIuVXNlcm5hbWUpIHsKICAgICAgICAgICAgICAgIFdyaXRlLVZlcmJvc2UgIiRtZW1iZXIgYWxyZWFkeSBoYXMgYWNjZXNzLiBTZXQgcmVzdWx0IHRvIGZhbHNlIgogICAgICAgICAgICAgICAgJHJlc3VsdCA9ICRmYWxzZQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgV3JpdGUtVmVyYm9zZSAiJG1lbWJlciBkb2VzIG5vdCBoYXZlIGFjY2Vzcy4gU2tpcHBpbmciCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgcmV0dXJuICRyZXN1bHQKfQoKRXhwb3J0LU1vZHVsZU1lbWJlciAtRnVuY3Rpb24gKi1UYXJnZXRSZXNvdXJjZQoK
